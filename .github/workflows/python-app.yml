name: Build ClockToDo EXE

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ v1.0.0 è¿™ç±» tag æ—¶è§¦å‘æ‰“åŒ…
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å¹¶ä¸Šä¼ èµ„äº§

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'  # ä½¿ç”¨ Python 3.8 ç‰ˆæœ¬
        cache: 'pip'  # å¯ç”¨pipç¼“å­˜

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install matplotlib
        pip install tk
        pip install tkcalendar
        pip install numpy

    - name: Create Version Info
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        $version = $version -replace '^v',''
        $version = if ($version) { $version } else { '1.0.0.0' }
        $version_parts = $version.Split('.')
        if ($version_parts.Length -lt 4) {
            $version = $version + ('.0' * (4 - $version_parts.Length))
        }
        $content = "# UTF-8`nVSVersionInfo(ffi=FixedFileInfo(filevers=($($version.Split('.') -join ',')),prodvers=($($version.Split('.') -join ',')),mask=0x3f,flags=0x0,OS=0x40004,fileType=0x1,subtype=0x0,date=(0, 0)),kids=[StringFileInfo([StringTable(u'080404b0',[StringStruct(u'CompanyName', u'ClockToDo'),StringStruct(u'FileDescription', u'ClockToDo - ä¸“æ³¨æ—¶é—´ç®¡ç†å·¥å…·'),StringStruct(u'FileVersion', u'$version'),StringStruct(u'InternalName', u'ClockToDo'),StringStruct(u'LegalCopyright', u'Copyright (c) 2025'),StringStruct(u'OriginalFilename', u'ClockToDo.exe'),StringStruct(u'ProductName', u'ClockToDo'),StringStruct(u'ProductVersion', u'$version')])])])"
        Set-Content -Path version_info.txt -Value $content -Encoding UTF8

    - name: Build EXE with PyInstaller
      run: |
        pyinstaller --clean -F -w -i clockToDo.ico --version-file version_info.txt --add-data "clockToDo.ico;." --name ClockToDo --hidden-import tkinter --hidden-import tkcalendar --hidden-import matplotlib main.py

    - name: Generate SHA-256 checksum
      shell: pwsh
      run: |
        $hash = Get-FileHash dist\ClockToDo.exe -Algorithm SHA256
        $hash.Hash | Out-File -FilePath dist\ClockToDo.exe.sha256

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ClockToDo
        path: |
          dist/ClockToDo.exe
          dist/ClockToDo.exe.sha256

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: "ClockToDo ${{ github.ref_name }}"
        body: |
          ## ClockToDo ${{ github.ref_name }}

          ### ğŸ“ ç‰ˆæœ¬è¯´æ˜
          - æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º
          - å‘å¸ƒæ—¶é—´ï¼š${{ github.event.head_commit.timestamp }}
          
          ### ğŸ” SHA-256 æ ¡éªŒ
          è¯·ä¸‹è½½åä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éªŒè¯æ–‡ä»¶å®Œæ•´æ€§ï¼š
          ```powershell
          Get-FileHash ClockToDo.exe -Algorithm SHA256
          ```
          
          ### ğŸ”’ å®‰å…¨æç¤º
          - æœ¬ç¨‹åºå®Œå…¨å¼€æºï¼Œä¸å«ä»»ä½•æ¶æ„ä»£ç 
          - ä»…åœ¨ç”¨æˆ· AppData ç›®å½•ä¿å­˜æ•°æ®
          - æ— ä»»ä½•ç½‘ç»œé€šä¿¡åŠŸèƒ½
          
          ### ğŸ“¥ æ–‡ä»¶æ¸…å•
          - ClockToDo.exe - ä¸»ç¨‹åº
          - ClockToDo.exe.sha256 - SHA256æ ¡éªŒæ–‡ä»¶
        files: |
          dist/ClockToDo.exe
          dist/ClockToDo.exe.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
